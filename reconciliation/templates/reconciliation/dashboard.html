{% extends "reconciliation/base.html" %}
{% load humanize %}

{% block title %}Reconciliation Dashboard - {{ pay_period.period_id }}{% endblock %}

{% block content %}
<header>
    <div class="breadcrumb">
        <a href="{% url 'reconciliation:pay_period_list' %}">Pay Periods</a> / {{ pay_period.period_id }}
    </div>
    <h1>Reconciliation Dashboard</h1>
    <p>
        <strong>Pay Period:</strong> {{ pay_period.period_id }}
        ({{ pay_period.period_start|date:"d M Y" }} - {{ pay_period.period_end|date:"d M Y" }})
    </p>
    <p>
        <strong>Reconciliation Run:</strong> {{ recon_run.run_id }} |
        <strong>Status:</strong> <span class="badge badge-success">{{ recon_run.status }}</span> |
        <strong>Completed:</strong> {{ recon_run.completed_at|date:"d M Y H:i" }}
    </p>
</header>

{% if error %}
<div class="alert alert-warning">{{ error }}</div>
{% else %}

<!-- Overall Summary Stats -->
<div class="summary-grid">
    <div class="stat-box primary">
        <div class="stat-label">Total Employees</div>
        <div class="stat-value">{{ overall_summary.total_employees }}</div>
    </div>
    <div class="stat-box success">
        <div class="stat-label">Hours Match</div>
        <div class="stat-value">{{ overall_summary.hours_match_pct|floatformat:1 }}%</div>
        <small>{{ overall_summary.hours_match_count }} / {{ overall_summary.total_employees }}</small>
    </div>
    <div class="stat-box success">
        <div class="stat-label">Cost Match</div>
        <div class="stat-value">{{ overall_summary.cost_match_pct|floatformat:1 }}%</div>
        <small>{{ overall_summary.cost_match_count }} / {{ overall_summary.total_employees }}</small>
    </div>
    <div class="stat-box info">
        <div class="stat-label">IQB Grand Total</div>
        <div class="stat-value">${{ overall_summary.iqb_grand_total|floatformat:2|intcomma }}</div>
        <small>(incl. Super)</small>
    </div>
</div>

<!-- Table 1: Overall Summary -->
<h2>1. Overall Reconciliation Summary</h2>
<table>
    <thead>
        <tr>
            <th>Category</th>
            <th class="number">Tanda Total</th>
            <th class="number">IQB Total (excl. Super)</th>
            <th class="number">IQB Superannuation</th>
            <th class="number">$ Variance</th>
            <th class="number">Tanda Hours</th>
            <th class="number">IQB Hours</th>
            <th class="number">Hours Variance</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>Total</strong></td>
            <td class="number">${{ overall_summary.tanda_total_cost|floatformat:2|intcomma }}</td>
            <td class="number">${{ overall_summary.iqb_total_cost|floatformat:2|intcomma }}</td>
            <td class="number">${{ overall_summary.iqb_superannuation|floatformat:2|intcomma }}</td>
            <td class="number {% if overall_summary.cost_variance > 100 %}warning{% endif %}">
                ${{ overall_summary.cost_variance|floatformat:2|intcomma }}
            </td>
            <td class="number">{{ overall_summary.tanda_total_hours|floatformat:2|intcomma }}</td>
            <td class="number">{{ overall_summary.iqb_total_hours|floatformat:2|intcomma }}</td>
            <td class="number {% if overall_summary.hours_variance > 10 %}warning{% endif %}">
                {{ overall_summary.hours_variance|floatformat:2|intcomma }}
            </td>
        </tr>
        <tr>
            <td><strong>IQB Grand Total (with Super)</strong></td>
            <td class="number" colspan="2">${{ overall_summary.iqb_grand_total|floatformat:2|intcomma }}</td>
            <td colspan="5"></td>
        </tr>
    </tbody>
</table>

<!-- Table 2: Summary by Employment Type -->
<h2>2. Summary by Employment Type</h2>
<table>
    <thead>
        <tr>
            <th>Employment Type</th>
            <th class="number">Employees</th>
            <th class="number">Tanda/Auto Pay $</th>
            <th class="number">IQB $ (excl. Super)</th>
            <th class="number">Super</th>
            <th class="number">$ Variance</th>
            <th class="number">Tanda Hours</th>
            <th class="number">IQB Hours</th>
            <th class="number">Hours Variance</th>
        </tr>
    </thead>
    <tbody>
        {% for item in employment_type_summary %}
        <tr>
            <td>{{ item.employment_type|default:"Unspecified" }}</td>
            <td class="number">{{ item.employee_count|intcomma }}</td>
            <td class="number">${{ item.expected_cost|floatformat:2|intcomma }}</td>
            <td class="number">${{ item.iqb_total_cost|floatformat:2|intcomma }}</td>
            <td class="number">${{ item.iqb_superannuation|floatformat:2|intcomma }}</td>
            <td class="number {% if item.cost_variance > 100 %}warning{% endif %}">
                ${{ item.cost_variance|floatformat:2|intcomma }}
            </td>
            <td class="number">{{ item.tanda_total_hours|floatformat:2|intcomma }}</td>
            <td class="number">{{ item.iqb_total_hours|floatformat:2|intcomma }}</td>
            <td class="number {% if item.hours_variance > 10 %}warning{% endif %}">
                {{ item.hours_variance|floatformat:2|intcomma }}
            </td>
        </tr>
        {% endfor %}
        <tr style="border-top: 3px solid #2c3e50; font-weight: bold; background-color: #ecf0f1;">
            <td><strong>TOTAL</strong></td>
            <td class="number">{{ employment_type_totals.total_employees|intcomma }}</td>
            <td class="number">${{ employment_type_totals.total_expected_cost|floatformat:2|intcomma }}</td>
            <td class="number">${{ employment_type_totals.total_iqb_cost|floatformat:2|intcomma }}</td>
            <td class="number">${{ employment_type_totals.total_iqb_super|floatformat:2|intcomma }}</td>
            <td class="number">${{ employment_type_totals.total_cost_variance|floatformat:2|intcomma }}</td>
            <td class="number">{{ employment_type_totals.total_tanda_hours|floatformat:2|intcomma }}</td>
            <td class="number">{{ employment_type_totals.total_iqb_hours|floatformat:2|intcomma }}</td>
            <td class="number">{{ employment_type_totals.total_hours_variance|floatformat:2|intcomma }}</td>
        </tr>
    </tbody>
</table>

<!-- Table 3: Journal vs IQB Comparison -->
<h2>3. Journal vs IQB Comparison</h2>

<div class="summary-card">
    <h3>Summary</h3>
    <table>
        <thead>
            <tr>
                <th>Category</th>
                <th class="number">Amount</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>IQB Total Cost (excl. Super)</td>
                <td class="number">${{ journal_comparison.iqb_total_cost|floatformat:2|intcomma }}</td>
            </tr>
            <tr>
                <td>IQB Superannuation</td>
                <td class="number">${{ journal_comparison.iqb_superannuation|floatformat:2|intcomma }}</td>
            </tr>
            <tr style="border-top: 2px solid #3498db;">
                <td><strong>IQB Grand Total (with Super)</strong></td>
                <td class="number"><strong>${{ journal_comparison.iqb_grand_total|floatformat:2|intcomma }}</strong></td>
            </tr>
            <tr>
                <td><strong>Total Journal Cost (marked "Y")</strong></td>
                <td class="number"><strong>${{ journal_comparison.journal_total_cost|floatformat:2|intcomma }}</strong></td>
            </tr>
            <tr style="border-top: 2px solid #e74c3c;">
                <td><strong>Variance</strong></td>
                <td class="number {% if journal_comparison.variance > 1000 %}warning{% else %}positive{% endif %}">
                    <strong>${{ journal_comparison.variance|floatformat:2|intcomma }}</strong>
                    ({{ journal_comparison.variance_pct|floatformat:2 }}%)
                </td>
            </tr>
        </tbody>
    </table>
</div>

<h3>Journal Entry Breakdown</h3>
<table>
    <thead>
        <tr>
            <th>Description</th>
            <th>GL Account</th>
            <th class="number">Debit</th>
            <th class="number">Credit</th>
            <th class="number">Net Amount</th>
            <th>In Total Cost?</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody>
        {% for item in journal_comparison.journal_items %}
        <tr>
            <td>{{ item.description }}</td>
            <td>{{ item.gl_account }}</td>
            <td class="number">${{ item.journal_debit|floatformat:2|intcomma }}</td>
            <td class="number">${{ item.journal_credit|floatformat:2|intcomma }}</td>
            <td class="number">${{ item.journal_net|floatformat:2|intcomma }}</td>
            <td>
                {% if item.include_in_total_cost %}
                <span class="badge badge-success">Yes</span>
                {% else %}
                <span class="badge badge-info">No</span>
                {% endif %}
            </td>
            <td>
                {% if item.is_mapped %}
                <span class="badge badge-success">Mapped</span>
                {% else %}
                <span class="badge badge-danger">Unmapped</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
        <tr style="border-top: 3px solid #2c3e50; font-weight: bold; background-color: #ecf0f1;">
            <td colspan="2"><strong>TOTAL</strong></td>
            <td class="number">${{ journal_comparison.journal_totals.total_debit|floatformat:2|intcomma }}</td>
            <td class="number">${{ journal_comparison.journal_totals.total_credit|floatformat:2|intcomma }}</td>
            <td class="number">${{ journal_comparison.journal_totals.total_net|floatformat:2|intcomma }}</td>
            <td colspan="2"></td>
        </tr>
    </tbody>
</table>

{% if journal_comparison.unmapped_count > 0 %}
<div class="alert alert-warning">
    <strong>Warning:</strong> {{ journal_comparison.unmapped_count }} journal description(s) are not in the mapping file.
</div>
{% else %}
<div class="alert alert-info">
    <strong>Success:</strong> All journal descriptions are properly mapped.
</div>
{% endif %}

<!-- Next Steps Section -->
<h2 style="margin-top: 40px;">Next Steps</h2>

{% if journal_comparison.variance == 0 %}
    {% if pay_period.has_cost_allocation %}
        <!-- Cost allocation has been run -->
        <div class="next-steps">
            <div class="alert alert-success">
                <strong>Cost Allocation Complete!</strong> You can view the detailed allocation results, generate journal entries, or export to Sage Intacct.
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                <button onclick="saveAllEmployeeSnapshots()" class="btn btn-success" style="font-size: 16px; padding: 10px 20px;" id="saveSnapshotsBtn">
                    ðŸ’¾ Save ALL Employees
                </button>
                <a href="{% url 'reconciliation:cost_allocation_view' pay_period.period_id %}" class="btn btn-primary">
                    View/Edit Cost Allocation
                </a>
                <a href="{% url 'reconciliation:generate_journal' pay_period.period_id %}" class="btn btn-primary">
                    ðŸ“Š Generate Journal
                </a>
                <button class="btn btn-secondary" onclick="alert('Export to Sage Intacct - Coming soon!')">
                    Export to Sage Intacct
                </button>
            </div>
            <p style="margin-top: 8px; font-size: 13px; color: #666;">
                <em>ðŸ’¡ <strong>Save ALL Employees</strong> uses their current source selections (IQB, Tanda, or Override). To change sources, go to "View/Edit Cost Allocation".</em>
            </p>
        </div>
    {% else %}
        <!-- Variance is 0 but cost allocation not run yet -->
        <div class="next-steps">
            <div class="alert alert-success">
                <strong>Ready for Cost Allocation!</strong> The journal reconciliation is balanced. You can now verify Tanda mappings and run cost allocation.
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                <button onclick="saveAllEmployeeSnapshots()" class="btn btn-success" style="font-size: 16px; padding: 10px 20px;" id="saveSnapshotsBtn2">
                    ðŸ’¾ Save ALL Employees
                </button>
                <a href="{% url 'reconciliation:verify_mapping' pay_period.period_id %}" class="btn btn-primary">
                    Verify Tanda Mappings & Run Cost Allocation
                </a>
            </div>
            <p style="margin-top: 8px; font-size: 13px; color: #666;">
                <em>ðŸ’¡ Save ALL Employees to generate journal entries. Uses current source selections.</em>
            </p>
        </div>
    {% endif %}
{% else %}
    <!-- Variance is not 0 -->
    <div class="next-steps">
        <div class="alert alert-warning">
            <strong>Action Required:</strong> There is a variance of ${{ journal_comparison.variance|floatformat:2|intcomma }} between IQB and Journal. Please investigate before proceeding to cost allocation.
        </div>
    </div>
{% endif %}

{% endif %}

<style>
.next-steps {
    background-color: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    border: 2px solid #dee2e6;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s ease;
}

.btn-primary {
    background-color: #3498db;
    color: white;
}

.btn-primary:hover {
    background-color: #2980b9;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.btn-secondary {
    background-color: #95a5a6;
    color: white;
}

.btn-secondary:hover {
    background-color: #7f8c8d;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
</style>

<script>
function saveAllEmployeeSnapshots() {
    if (!confirm('This will save ALL employees for this pay period using their current source selections (IQB, Tanda, or Override).\n\nTo change sources, go to "View/Edit Cost Allocation" first.\n\nContinue?')) {
        return;
    }

    const payPeriodId = '{{ pay_period.period_id }}';
    const saveBtn1 = document.getElementById('saveSnapshotsBtn');
    const saveBtn2 = document.getElementById('saveSnapshotsBtn2');

    // Disable buttons and show loading
    [saveBtn1, saveBtn2].forEach(btn => {
        if (btn) {
            btn.disabled = true;
            btn.textContent = 'â³ Saving...';
        }
    });

    fetch(`/api/save-all-allocations/${payPeriodId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`âœ“ Successfully saved ${data.saved_count} employee snapshot(s)!\n\nYou can now generate journal entries.`);
            // Reload the page to update any snapshot counts
            location.reload();
        } else {
            alert(`Error: ${data.error || 'Unknown error occurred'}`);
        }
    })
    .catch(error => {
        console.error('Error saving snapshots:', error);
        alert('Failed to save snapshots. Please check the console for details.');
    })
    .finally(() => {
        // Re-enable buttons
        [saveBtn1, saveBtn2].forEach(btn => {
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'ðŸ’¾ Save ALL Employees';
            }
        });
    });
}
</script>

{% endblock %}
