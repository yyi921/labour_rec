{% extends "reconciliation/base.html" %}
{% load humanize %}

{% block title %}Cost Allocation View - {{ pay_period.period_id }}{% endblock %}

{% block content %}
<header>
    <div class="breadcrumb">
        <a href="{% url 'reconciliation:pay_period_list' %}">Pay Periods</a> /
        <a href="{% url 'reconciliation:dashboard' pay_period.period_id %}">{{ pay_period.period_id }}</a> /
        Cost Allocation
    </div>
    <h1>Cost Allocation View</h1>
    <p>
        <strong>Pay Period:</strong> {{ pay_period.period_id }}
        ({{ pay_period.period_start|date:"d M Y" }} - {{ pay_period.period_end|date:"d M Y" }})
    </p>
</header>

{% if error %}
<div class="alert alert-warning">{{ error }}</div>
{% else %}

<!-- GL Summary Section -->
<div class="gl-summary">
    <h2>GL Account Summary</h2>
    <p><small>Total should match IQB Grand Total from Dashboard</small></p>
    <table class="summary-table">
        <thead>
            <tr>
                <th>GL Account</th>
                <th>Description</th>
                <th class="number">Total</th>
            </tr>
        </thead>
        <tbody>
            {% for item in gl_totals.items %}
            <tr>
                <td>{{ item.gl_account }}</td>
                <td>{{ item.gl_name }}</td>
                <td class="number">${{ item.total|floatformat:2|intcomma }}</td>
            </tr>
            {% endfor %}
            <tr style="border-top: 3px solid #2c3e50; font-weight: bold; background-color: #ecf0f1;">
                <td colspan="2"><strong>IQB GRAND TOTAL</strong></td>
                <td class="number"><strong>${{ gl_totals.grand_total|floatformat:2|intcomma }}</strong></td>
            </tr>
        </tbody>
    </table>
</div>

<!-- View Toggle and Filters -->
<div class="controls-section">
    <div class="view-toggle">
        <h3>View Mode</h3>
        <div class="toggle-buttons">
            <button class="toggle-btn {% if view_mode == 'percentage' %}active{% endif %}"
                    onclick="changeView('percentage')">
                % Allocation by Cost Center
            </button>
            <button class="toggle-btn {% if view_mode == 'dollar' %}active{% endif %}"
                    onclick="changeView('dollar')">
                $ Value by GL
            </button>
        </div>
    </div>

    <div class="filters">
        <h3>Filters</h3>
        <form method="GET" id="filterForm">
            <input type="hidden" name="view" id="viewInput" value="{{ view_mode }}">

            <div class="filter-group">
                <label for="locationFilter">Sage Location:</label>
                <select name="location" id="locationFilter" onchange="applyFilters()">
                    <option value="">All Locations</option>
                    {% for loc in locations %}
                    <option value="{{ loc.location_id }}" {% if selected_location == loc.location_id %}selected{% endif %}>
                        {{ loc.location_id }} - {{ loc.location_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label for="departmentFilter">Sage Department:</label>
                <select name="department" id="departmentFilter" onchange="applyFilters()">
                    <option value="">All Departments</option>
                    {% for dept in departments %}
                    <option value="{{ dept.department_id }}" {% if selected_department == dept.department_id %}selected{% endif %}>
                        {{ dept.department_id }} - {{ dept.department_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <button type="button" onclick="clearFilters()" class="btn btn-secondary">Clear Filters</button>
        </form>
    </div>
</div>

<!-- Employee Allocation Table -->
<div class="allocation-section">
    <h2>Employee Cost Allocations</h2>

    {% if show_filter_message %}
    <div class="alert alert-info" style="background-color: #e3f2fd; padding: 20px; margin: 20px 0; border-left: 4px solid #2196F3;">
        <h3 style="margin-top: 0;">Select Location or Department to View Data</h3>
        <p>To improve performance, please select at least one filter (Location or Department) above to load employee allocation data.</p>
        <p><small>You can select "All Locations" and "All Departments" after the initial load if you want to view all data.</small></p>
    </div>
    {% else %}
    <p><small>Total Employees: {{ employees|length }}</small></p>

    <!-- Bulk Actions Section -->
    <div class="bulk-actions-section" style="background-color: #f0f8ff; padding: 20px; margin-bottom: 20px; border-radius: 5px; border: 2px solid #2196F3;">
        <h3 style="margin-top: 0; margin-bottom: 15px; font-size: 18px; color: #2c3e50;">ðŸ“‹ Quick Source Selection (Visible Employees Only)</h3>
        <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
            <div style="display: flex; gap: 15px;">
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 15px;">
                    <input type="radio" name="bulk-source" value="iqb" onchange="applyBulkSourceToVisible('iqb')" style="width: 18px; height: 18px;">
                    <strong>IQB</strong>
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 15px;">
                    <input type="radio" name="bulk-source" value="tanda" onchange="applyBulkSourceToVisible('tanda')" style="width: 18px; height: 18px;">
                    <strong>Tanda</strong>
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 15px;">
                    <input type="radio" name="bulk-source" value="override" onchange="applyBulkSourceToVisible('override')" style="width: 18px; height: 18px;">
                    <strong>Override</strong>
                </label>
            </div>
        </div>
        <p style="margin: 15px 0 0 0; font-size: 14px; color: #555; background-color: #fff; padding: 12px; border-radius: 4px; border-left: 4px solid #2196F3;">
            <strong>ðŸ’¡ How it works:</strong> Selecting a source above will <strong>immediately update all {{ employees|length }} visible employees</strong> on this page.
            Then click "Save Visible Employees" below to save only these employees.
            <br><br>
            <em>Note: Employees not shown on this page will not be affected.</em>
        </p>
    </div>

    <div style="margin-bottom: 15px;">
        <button onclick="saveVisibleEmployees()" class="btn btn-success" style="font-size: 16px; padding: 10px 20px;">
            ðŸ’¾ Save Visible Employees ({{ employees|length }})
        </button>
        <a href="{% url 'reconciliation:dashboard' pay_period.period_id %}" class="btn btn-secondary">Back to Dashboard</a>
        <p style="margin-top: 8px; font-size: 13px; color: #666;">
            <em>ðŸ’¡ This will save only the {{ employees|length }} employees shown on this page. Other employees will not be affected.</em>
        </p>
    </div>

    <table class="allocation-table">
        <thead>
            <tr>
                <th style="width: 40px;">
                    <input type="checkbox" id="select-all" onchange="toggleSelectAll(this)">
                </th>
                <th>Employee Code</th>
                <th>Employee Name</th>
                <th>Location</th>
                <th class="number">Total Cost</th>
                <th>IQB Allocation</th>
                <th>Tanda Allocation</th>
                <th>Override Input</th>
                <th>Source Selection</th>
            </tr>
        </thead>
        <tbody>
            {% for emp in employees %}
            <tr data-employee="{{ emp.employee_code }}" data-default-source="{{ emp.default_source }}" data-has-tanda="{{ emp.has_tanda|yesno:'true,false' }}">
                <td style="text-align: center;">
                    <input type="checkbox" class="employee-select" data-employee="{{ emp.employee_code }}">
                </td>
                <td>{{ emp.employee_code }}</td>
                <td>{{ emp.employee_name }}</td>
                <td>{{ emp.employee_location|default:"N/A" }}</td>
                <td class="number">${{ emp.total_cost|floatformat:2|intcomma }}</td>

                <!-- IQB Allocation -->
                <td class="allocation-cell">
                    {% if view_mode == 'percentage' %}
                        {% for cost_account, details in emp.iqb_allocation.items %}
                        <div class="allocation-line">
                            {{ cost_account }}: {{ details.percentage|floatformat:2 }}%
                        </div>
                        {% endfor %}
                    {% else %}
                        {% for cost_account, details in emp.iqb_allocation.items %}
                        <div class="allocation-line">
                            {{ cost_account }}: ${{ details.amount|floatformat:2|intcomma }}
                        </div>
                        {% endfor %}
                    {% endif %}
                </td>

                <!-- Tanda Allocation -->
                <td class="allocation-cell">
                    {% if emp.has_tanda %}
                        {% if view_mode == 'percentage' %}
                            {% for cost_account, details in emp.tanda_allocation.items %}
                            <div class="allocation-line">
                                {{ cost_account }}: {{ details.percentage|floatformat:2 }}%
                            </div>
                            {% endfor %}
                        {% else %}
                            {% for cost_account, details in emp.tanda_allocation.items %}
                            <div class="allocation-line">
                                {{ cost_account }}: ${{ details.amount|floatformat:2|intcomma }}
                            </div>
                            {% endfor %}
                        {% endif %}
                    {% else %}
                        <span class="no-data">No Tanda Timesheets Found</span>
                    {% endif %}
                </td>

                <!-- Override Input -->
                <td>
                    <textarea class="override-input"
                              id="override-{{ emp.employee_code }}"
                              data-employee="{{ emp.employee_code }}"
                              rows="4"
                              placeholder="421-5000: 60, 422-5000: 40"
                              onblur="saveOverrideIfSelected(this)"
                    >{% if emp.override_allocation %}{% for cost_account, details in emp.override_allocation.items %}{{ cost_account }}: {{ details.percentage|floatformat:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}{% else %}{% for cost_account, details in emp.expanded_allocation.items %}{{ cost_account }}: {{ details.percentage|floatformat:2 }}{% if not forloop.last %}, {% endif %}{% endfor %}{% endif %}</textarea>
                    <div class="validation-error" id="error-{{ emp.employee_code }}"></div>
                </td>

                <!-- Source Selection -->
                <td class="source-selection">
                    <label>
                        <input type="radio"
                               name="source-{{ emp.employee_code }}"
                               value="iqb"
                               {% if emp.current_source == 'iqb' %}checked{% endif %}
                               onchange="updateSource('{{ emp.employee_code }}', 'iqb')">
                        IQB
                    </label>
                    <label>
                        <input type="radio"
                               name="source-{{ emp.employee_code }}"
                               value="tanda"
                               {% if emp.current_source == 'tanda' %}checked{% endif %}
                               {% if not emp.has_tanda %}disabled{% endif %}
                               onchange="updateSource('{{ emp.employee_code }}', 'tanda')">
                        Tanda
                    </label>
                    <label>
                        <input type="radio"
                               name="source-{{ emp.employee_code }}"
                               value="override"
                               {% if emp.current_source == 'override' %}checked{% endif %}
                               onchange="updateSource('{{ emp.employee_code }}', 'override')">
                        Override
                    </label>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div style="margin-top: 15px;">
        <button onclick="saveVisibleEmployees()" class="btn btn-success" style="font-size: 16px; padding: 10px 20px;">
            ðŸ’¾ Save Visible Employees ({{ employees|length }})
        </button>
        <a href="{% url 'reconciliation:dashboard' pay_period.period_id %}" class="btn btn-secondary">Back to Dashboard</a>
    </div>
    {% endif %}
</div>

{% endif %}

<style>
/* GL Summary */
.gl-summary {
    margin: 30px 0;
    background-color: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
}

.summary-table {
    width: 600px;
    margin-top: 10px;
}

/* Controls Section */
.controls-section {
    background-color: #ffffff;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
}

.view-toggle {
    margin-bottom: 20px;
}

.toggle-buttons {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.toggle-btn {
    padding: 12px 24px;
    border: 2px solid #3498db;
    background-color: white;
    color: #3498db;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.toggle-btn:hover {
    background-color: #e8f4f8;
}

.toggle-btn.active {
    background-color: #3498db;
    color: white;
}

.filters {
    border-top: 1px solid #dee2e6;
    padding-top: 20px;
}

.filter-group {
    display: inline-block;
    margin-right: 20px;
    margin-bottom: 10px;
}

.filter-group label {
    display: inline-block;
    margin-right: 8px;
    font-weight: 500;
}

.filter-group select {
    padding: 8px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
    min-width: 250px;
}

/* Allocation Section */
.allocation-section {
    margin: 30px 0;
}

.allocation-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    font-size: 13px;
}

.allocation-table th,
.allocation-table td {
    padding: 10px;
    border: 1px solid #dee2e6;
    text-align: left;
}

.allocation-table th {
    background-color: #2c3e50;
    color: white;
    font-weight: 600;
}

.allocation-table tbody tr:nth-child(even) {
    background-color: #f8f9fa;
}

.allocation-table tbody tr:hover {
    background-color: #e9ecef;
}

.allocation-cell {
    font-family: 'Courier New', monospace;
    font-size: 12px;
}

.allocation-line {
    margin: 2px 0;
}

.no-data {
    color: #6c757d;
    font-style: italic;
}

.override-input {
    width: 100%;
    min-width: 300px;
    padding: 6px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    resize: vertical;
    line-height: 1.4;
}

.override-input:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
}

.validation-error {
    color: #e74c3c;
    font-size: 11px;
    margin-top: 3px;
    min-height: 15px;
}

.source-selection {
    white-space: nowrap;
}

.source-selection label {
    display: block;
    margin: 4px 0;
    cursor: pointer;
}

.source-selection input[type="radio"] {
    margin-right: 5px;
    cursor: pointer;
}

.source-selection input[type="radio"]:disabled {
    cursor: not-allowed;
}

/* Buttons */
.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
    display: inline-block;
    margin-right: 10px;
    transition: all 0.3s ease;
}

.btn-primary {
    background-color: #3498db;
    color: white;
}

.btn-primary:hover {
    background-color: #2980b9;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.btn-secondary {
    background-color: #95a5a6;
    color: white;
}

.btn-secondary:hover {
    background-color: #7f8c8d;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.alert {
    padding: 15px;
    border-radius: 4px;
    margin: 20px 0;
}

.alert-warning {
    background-color: #fff3cd;
    border: 1px solid #ffc107;
    color: #856404;
}

.number {
    text-align: right;
}
</style>

<script>
// Store employee selections in session storage to persist across view/filter changes
const STORAGE_KEY = 'cost_allocation_selections_{{ pay_period.period_id }}';

// Load saved selections on page load
window.addEventListener('DOMContentLoaded', function() {
    loadSelections();
});

function loadSelections() {
    const saved = sessionStorage.getItem(STORAGE_KEY);
    if (!saved) return;

    try {
        const selections = JSON.parse(saved);

        // Restore radio button selections
        for (const [empCode, source] of Object.entries(selections.sources || {})) {
            const radio = document.querySelector(`input[name="source-${empCode}"][value="${source}"]`);
            if (radio) radio.checked = true;
        }

        // Restore override inputs
        for (const [empCode, override] of Object.entries(selections.overrides || {})) {
            const input = document.getElementById(`override-${empCode}`);
            if (input && override) input.value = override;
        }
    } catch (e) {
        console.error('Error loading selections:', e);
    }
}

function saveSelections() {
    const selections = {
        sources: {},
        overrides: {}
    };

    // Save all radio selections
    document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
        const match = radio.name.match(/source-(.+)/);
        if (match) {
            selections.sources[match[1]] = radio.value;
        }
    });

    // Save all override inputs
    document.querySelectorAll('.override-input').forEach(input => {
        const match = input.id.match(/override-(.+)/);
        if (match && input.value.trim()) {
            selections.overrides[match[1]] = input.value.trim();
        }
    });

    sessionStorage.setItem(STORAGE_KEY, JSON.stringify(selections));
}

function changeView(viewMode) {
    saveSelections();
    document.getElementById('viewInput').value = viewMode;
    document.getElementById('filterForm').submit();
}

function applyFilters() {
    saveSelections();
    document.getElementById('filterForm').submit();
}

function clearFilters() {
    saveSelections();
    document.getElementById('locationFilter').value = '';
    document.getElementById('departmentFilter').value = '';
    document.getElementById('filterForm').submit();
}

function saveOverrideIfSelected(textarea) {
    const empCode = textarea.getAttribute('data-employee');
    const overrideRadio = document.querySelector(`input[name="source-${empCode}"][value="override"]`);

    // Only auto-save if the Override radio button is selected
    if (overrideRadio && overrideRadio.checked) {
        updateSource(empCode, 'override');
    }
}

function updateSource(empCode, source) {
    saveSelections();

    // Auto-save immediately to persist across all pages
    const payPeriodId = '{{ pay_period.period_id }}';

    // Get override value if source is override
    let changes = [{
        employee_code: empCode,
        source: source
    }];

    if (source === 'override') {
        const overrideInput = document.querySelector(`#override-${empCode}`);
        if (overrideInput && overrideInput.value.trim()) {
            const validation = validateOverride(overrideInput.value);
            if (!validation.valid) {
                alert(`Validation error: ${validation.error}`);
                return;
            }
            changes[0].override = validation.allocations;
        } else {
            // Override selected but no value entered yet - save source but use IQB allocation as fallback
            // The user will need to enter an override value and it will auto-save when they finish typing
            console.log(`Override selected for ${empCode} but no value entered yet`);
            // Don't return - still save the source preference
        }
    }

    // Save to backend immediately
    fetch(`/api/save-cost-allocations/${payPeriodId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ changes: changes })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log(`Auto-saved ${empCode} with source: ${source}`);
            // Optional: Show a subtle notification
            // You could add a small green checkmark or toast notification here
        } else {
            console.error(`Failed to auto-save ${empCode}:`, data.error);
            alert(`Failed to save: ${data.error || 'Unknown error'}`);
        }
    })
    .catch(error => {
        console.error('Auto-save error:', error);
    });
}

function validateOverride(input) {
    // Format: "421-5000: 60, 422-5000: 40" or "421-5000: 60%, 422-5000: 40%"
    const value = input.trim();
    if (!value) return { valid: true, allocations: {} };

    const allocations = {};
    const parts = value.split(',');

    for (const part of parts) {
        const match = part.trim().match(/^(\d{3}-\d{4}):\s*(\d+\.?\d*)%?$/);
        if (!match) {
            return { valid: false, error: 'Invalid format. Use: 421-5000: 60, 422-5000: 40' };
        }

        const costAccount = match[1];
        const percentage = parseFloat(match[2]);

        if (percentage < 0 || percentage > 100) {
            return { valid: false, error: 'Percentages must be between 0 and 100' };
        }

        allocations[costAccount] = {
            percentage: percentage,
            amount: 0  // Will be calculated by backend
        };
    }

    const total = Object.values(allocations).reduce((sum, item) => sum + item.percentage, 0);
    if (Math.abs(total - 100) > 0.1) {
        return { valid: false, error: `Total is ${total.toFixed(1)}%, must be 100%` };
    }

    return { valid: true, allocations };
}

function saveAllocations() {
    // Collect all changes
    const changes = [];
    let hasErrors = false;

    document.querySelectorAll('[data-employee]').forEach(row => {
        const empCode = row.getAttribute('data-employee');
        const sourceRadio = row.querySelector(`input[name="source-${empCode}"]:checked`);
        const overrideInput = row.querySelector(`#override-${empCode}`);
        const errorDiv = row.querySelector(`#error-${empCode}`);

        const source = sourceRadio ? sourceRadio.value : 'iqb';

        // Clear previous errors
        if (errorDiv) {
            errorDiv.textContent = '';
            errorDiv.style.display = 'none';
        }

        // Validate override if selected
        if (source === 'override') {
            const validation = validateOverride(overrideInput.value);
            if (!validation.valid) {
                if (errorDiv) {
                    errorDiv.textContent = validation.error;
                    errorDiv.style.display = 'block';
                } else {
                    alert(`Validation error for employee ${empCode}: ${validation.error}`);
                }
                hasErrors = true;
                return;
            }

            changes.push({
                employee_code: empCode,
                source: source,
                override: validation.allocations
            });
        } else {
            changes.push({
                employee_code: empCode,
                source: source
            });
        }
    });

    if (hasErrors) {
        alert('Please fix validation errors before saving');
        return;
    }

    if (changes.length === 0) {
        alert('No changes to save');
        return;
    }

    // Save selections before navigating
    saveSelections();

    // Send to backend API
    const payPeriodId = '{{ pay_period.period_id }}';
    const saveButton = document.querySelector('button[onclick="saveAllocations()"]');

    // Disable button and show loading
    if (saveButton) {
        saveButton.disabled = true;
        saveButton.textContent = 'Saving...';
    }

    fetch(`/api/save-cost-allocations/${payPeriodId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ changes: changes })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Successfully saved ${data.saved_count} allocation snapshot(s)!\n\nAllocations have been grouped by location and department.`);
            // Optionally redirect to dashboard or review page
            // window.location.href = `/dashboard/${payPeriodId}/`;
        } else {
            alert(`Error: ${data.error || 'Unknown error occurred'}`);
        }
    })
    .catch(error => {
        console.error('Error saving allocations:', error);
        alert('Failed to save allocations. Please check the console for details.');
    })
    .finally(() => {
        // Re-enable button
        if (saveButton) {
            saveButton.disabled = false;
            saveButton.textContent = 'Save Changes (Visible Only)';
        }
    });
}

// Apply bulk source selection to all visible employees
function applyBulkSourceToVisible(source) {
    let appliedCount = 0;
    let skippedCount = 0;

    // Loop through all visible employee rows
    document.querySelectorAll('[data-employee]').forEach(row => {
        const empCode = row.getAttribute('data-employee');
        const hasTanda = row.getAttribute('data-has-tanda') === 'true';

        // Skip if trying to apply Tanda but employee doesn't have Tanda data
        if (source === 'tanda' && !hasTanda) {
            skippedCount++;
            return;
        }

        // Find and check the appropriate radio button for this employee
        const radio = row.querySelector(`input[name="source-${empCode}"][value="${source}"]`);
        if (radio && !radio.disabled) {
            radio.checked = true;
            appliedCount++;
        } else {
            skippedCount++;
        }
    });

    console.log(`Applied ${source} to ${appliedCount} visible employees. Skipped ${skippedCount}.`);
}

// Save only the visible employees on this page
function saveVisibleEmployees() {
    const visibleEmployees = document.querySelectorAll('[data-employee]');

    if (!confirm(`This will save ${visibleEmployees.length} visible employees with their selected sources. Continue?`)) {
        return;
    }

    const payPeriodId = '{{ pay_period.period_id }}';
    const saveButtons = document.querySelectorAll('button[onclick="saveVisibleEmployees()"]');

    // Disable buttons and show loading
    saveButtons.forEach(btn => {
        btn.disabled = true;
        btn.textContent = 'â³ Saving...';
    });

    // Collect changes for visible employees only
    const changes = [];
    let hasErrors = false;

    visibleEmployees.forEach(row => {
        const empCode = row.getAttribute('data-employee');
        const sourceRadio = row.querySelector(`input[name="source-${empCode}"]:checked`);

        if (!sourceRadio) {
            console.warn(`No source selected for employee ${empCode}`);
            return;
        }

        const source = sourceRadio.value;
        const change = {
            employee_code: empCode,
            source: source
        };

        // If override is selected, get the override value
        if (source === 'override') {
            const overrideInput = row.querySelector(`#override-${empCode}`);
            if (overrideInput && overrideInput.value.trim()) {
                const validation = validateOverride(overrideInput.value);
                if (!validation.valid) {
                    alert(`Validation error for employee ${empCode}: ${validation.error}`);
                    hasErrors = true;
                    return;
                }
                change.override = validation.allocations;
            }
        }

        changes.push(change);
    });

    if (hasErrors) {
        saveButtons.forEach(btn => {
            btn.disabled = false;
            btn.textContent = 'ðŸ’¾ Save Visible Employees';
        });
        return;
    }

    if (changes.length === 0) {
        alert('No employees to save');
        saveButtons.forEach(btn => {
            btn.disabled = false;
            btn.textContent = 'ðŸ’¾ Save Visible Employees';
        });
        return;
    }

    // Save visible employees
    fetch(`/api/save-cost-allocations/${payPeriodId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ changes: changes })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`âœ“ Successfully saved ${data.saved_count} employee allocation(s)!`);
            location.reload();
        } else {
            alert(`Error: ${data.error || 'Unknown error occurred'}`);
        }
    })
    .catch(error => {
        console.error('Error saving allocations:', error);
        alert('Failed to save allocations. Please check the console for details.');
    })
    .finally(() => {
        // Re-enable buttons
        saveButtons.forEach(btn => {
            btn.disabled = false;
            btn.textContent = 'ðŸ’¾ Save Visible Employees';
        });
    });
}

// Initialize default source selections on page load
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[data-employee]').forEach(row => {
        const empCode = row.getAttribute('data-employee');
        const defaultSource = row.getAttribute('data-default-source');
        const currentChecked = row.querySelector(`input[name="source-${empCode}"]:checked`);

        // If no source is currently selected or if we want to apply the default based on location
        // The default is already set in the backend, so this is just for visual confirmation
        // You can add a button or checkbox to "Apply Defaults" if needed

        // Optional: Add a tooltip or indicator showing the recommended source
        const locationCell = row.querySelector('td:nth-child(4)'); // Changed from 3 to 4 due to new checkbox column
        if (locationCell && defaultSource) {
            const recommendedText = defaultSource === 'tanda' ? ' (â†’Tanda)' : ' (â†’IQB)';
            const location = locationCell.textContent;
            if (location === 'Culinary' || location === 'Stewarding') {
                locationCell.innerHTML = location + '<small style="color: #2196F3; font-weight: bold;">' + recommendedText + '</small>';
            }
        }
    });
});

// Toggle select all checkboxes
function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.employee-select');
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
}

// Apply bulk source selection to all visible employees
function applyBulkToAll() {
    const selectedSource = document.querySelector('input[name="bulk-source"]:checked').value;

    let appliedCount = 0;
    let skippedCount = 0;

    document.querySelectorAll('[data-employee]').forEach(row => {
        const empCode = row.getAttribute('data-employee');
        const hasTanda = row.getAttribute('data-has-tanda') === 'true';

        // Skip if trying to apply Tanda but employee doesn't have Tanda data
        if (selectedSource === 'tanda' && !hasTanda) {
            skippedCount++;
            return;
        }

        // Find and check the appropriate radio button
        const radio = row.querySelector(`input[name="source-${empCode}"][value="${selectedSource}"]`);
        if (radio && !radio.disabled) {
            radio.checked = true;
            updateSource(empCode, selectedSource);
            appliedCount++;
        } else {
            skippedCount++;
        }
    });

    let message = `Applied ${selectedSource.toUpperCase()} to ${appliedCount} employee(s).`;
    if (skippedCount > 0) {
        message += ` Skipped ${skippedCount} employee(s) (no Tanda data or disabled).`;
    }
    alert(message);
}

// Apply bulk source selection to selected employees only
function applyBulkToSelected() {
    const selectedSource = document.querySelector('input[name="bulk-source"]:checked').value;
    const selectedCheckboxes = document.querySelectorAll('.employee-select:checked');

    if (selectedCheckboxes.length === 0) {
        alert('Please select at least one employee using the checkboxes.');
        return;
    }

    let appliedCount = 0;
    let skippedCount = 0;

    selectedCheckboxes.forEach(checkbox => {
        const empCode = checkbox.getAttribute('data-employee');
        const row = checkbox.closest('tr');
        const hasTanda = row.getAttribute('data-has-tanda') === 'true';

        // Skip if trying to apply Tanda but employee doesn't have Tanda data
        if (selectedSource === 'tanda' && !hasTanda) {
            skippedCount++;
            return;
        }

        // Find and check the appropriate radio button
        const radio = row.querySelector(`input[name="source-${empCode}"][value="${selectedSource}"]`);
        if (radio && !radio.disabled) {
            radio.checked = true;
            updateSource(empCode, selectedSource);
            appliedCount++;
        } else {
            skippedCount++;
        }
    });

    let message = `Applied ${selectedSource.toUpperCase()} to ${appliedCount} selected employee(s).`;
    if (skippedCount > 0) {
        message += ` Skipped ${skippedCount} employee(s) (no Tanda data or disabled).`;
    }
    alert(message);

    // Uncheck all checkboxes after applying
    document.getElementById('select-all').checked = false;
    selectedCheckboxes.forEach(cb => cb.checked = false);
}
</script>

{% endblock %}
