{% extends "reconciliation/base.html" %}

{% block title %}Pay Periods - Reconciliation Dashboard{% endblock %}

{% block content %}
<header>
    <h1>Reconciliation Dashboards</h1>
    <p>Select a pay period to view the reconciliation dashboard</p>
    <div style="margin-top: 15px;">
        <a href="{% url 'reconciliation:multi_upload' %}" class="btn btn-primary" style="background-color: #3498db; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; display: inline-block;">
            üìÅ Multi-File Upload
        </a>
        <button id="deleteSelectedBtn" class="btn btn-danger" style="background-color: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;" onclick="deleteSelected()">
            üóëÔ∏è Delete Selected
        </button>
    </div>
</header>

<table>
    <thead>
        <tr>
            <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
            <th>Pay Period</th>
            <th>Period Start</th>
            <th>Period End</th>
            <th>Status</th>
            <th>Data Status</th>
            <th>Latest Reconciliation</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {% for pp in pay_periods %}
        <tr>
            <td><input type="checkbox" class="period-checkbox" value="{{ pp.period_id }}"></td>
            <td><strong>{{ pp.period_id }}</strong></td>
            <td>{{ pp.period_start|date:"d M Y" }}</td>
            <td>{{ pp.period_end|date:"d M Y" }}</td>
            <td>
                {% if pp.status == 'completed' %}
                <span class="badge badge-success">{{ pp.status }}</span>
                {% elif pp.status == 'uploaded' %}
                <span class="badge badge-info">{{ pp.status }}</span>
                {% else %}
                <span class="badge badge-warning">{{ pp.status }}</span>
                {% endif %}
            </td>
            <td>
                {% if pp.has_tanda %}<span class="badge badge-success">Tanda</span>{% endif %}
                {% if pp.has_iqb %}<span class="badge badge-success">IQB</span>{% endif %}
                {% if pp.has_journal %}<span class="badge badge-success">Journal</span>{% endif %}
            </td>
            <td>
                {% if pp.latest_recon %}
                {{ pp.latest_recon.completed_at|date:"d M Y H:i" }}
                <br><small>{{ pp.latest_recon.status }}</small>
                {% else %}
                <span class="badge badge-warning">No reconciliation</span>
                {% endif %}
            </td>
            <td>
                {% if pp.process_type == 'payroll_tax_wc' %}
                <a href="{% url 'reconciliation:prt_wc_dashboard' pp.period_id %}" class="btn">View PRT/WC Dashboard</a>
                {% elif pp.latest_recon or pp.period_type == 'accrual' or pp.period_type == 'accrual_reversal' or pp.status == 'accrual_processed' or pp.status == 'accrual_reversed' %}
                <a href="{% url 'reconciliation:dashboard' pp.period_id %}" class="btn">View Dashboard</a>
                {% else %}
                <span style="color: #95a5a6;">No data</span>
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="8" style="text-align: center; padding: 40px; color: #95a5a6;">
                No pay periods found
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.period-checkbox');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
}

function deleteSelected() {
    const checkboxes = document.querySelectorAll('.period-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('Please select at least one pay period to delete.');
        return;
    }

    const periodIds = Array.from(checkboxes).map(cb => cb.value);
    const confirmMsg = `Are you sure you want to delete ${periodIds.length} pay period(s)?\n\nPay Periods: ${periodIds.join(', ')}\n\nThis will delete all associated reconciliations, uploads, and data.`;

    if (!confirm(confirmMsg)) {
        return;
    }

    // Send delete request to backend
    fetch('/api/pay-periods/delete/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ period_ids: periodIds })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Successfully deleted ${data.deleted_count} pay period(s)`);
            location.reload();
        } else {
            alert(`Error: ${data.error || 'Failed to delete pay periods'}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete pay periods. Please check the console for details.');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% endblock %}
