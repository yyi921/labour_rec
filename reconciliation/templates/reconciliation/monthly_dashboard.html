{% extends 'reconciliation/base.html' %}

{% block title %}Monthly Dashboard - Labour Reconciliation{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<style>
    .dashboard-section {
        background: white;
        padding: 25px;
        margin-bottom: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .filter-row {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: end;
    }

    .filter-group {
        flex: 1;
        min-width: 200px;
    }

    .filter-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #555;
    }

    .filter-group select,
    .filter-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    .filter-group select[multiple] {
        height: 120px;
    }

    button {
        background: #3498db;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
    }

    button:hover {
        background: #2980b9;
    }

    button.download-btn {
        background: #27ae60;
    }

    button.download-btn:hover {
        background: #229954;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }

    .stat-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        border-left: 4px solid #3498db;
    }

    .stat-label {
        font-size: 12px;
        color: #777;
        text-transform: uppercase;
        margin-bottom: 5px;
    }

    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #2c3e50;
    }

    .breakdown-table, .comparison-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .breakdown-table th,
    .breakdown-table td,
    .comparison-table th,
    .comparison-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #eee;
    }

    .breakdown-table th,
    .comparison-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #555;
    }

    .breakdown-table tr:hover,
    .comparison-table tbody tr:hover {
        background: #f8f9fa;
    }

    .text-right {
        text-align: right !important;
    }

    .positive {
        color: #27ae60;
    }

    .negative {
        color: #e74c3c;
    }

    .chart-container {
        position: relative;
        height: 400px;
        margin: 20px 0;
    }

    .section-title {
        font-size: 20px;
        color: #2c3e50;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #3498db;
    }

    .help-text {
        font-size: 13px;
        color: #777;
        margin-top: 5px;
    }

    .waterfall-legend {
        display: flex;
        gap: 20px;
        margin-top: 15px;
        flex-wrap: wrap;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
    }

    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 3px;
    }

    .summary-totals {
        background: #e8f4f8;
        padding: 15px;
        border-radius: 6px;
        margin-top: 10px;
    }

    .summary-totals .stat-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <header>
        <h1>Monthly Dashboard</h1>
        <p>Comprehensive labour cost analysis and comparison</p>
    </header>

    <!-- SECTION 1: Single Month Breakdown -->
    <div class="dashboard-section">
        <h2 class="section-title">üìä Monthly Cost Breakdown</h2>

        <form method="get" action="">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="month">Select Month:</label>
                    <select id="month" name="month">
                        <option value="">-- Select Month --</option>
                        {% for month_option in month_options %}
                            <option value="{{ month_option.value }}" {% if month_option.value == selected_month %}selected{% endif %}>
                                {{ month_option.label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button type="submit">View Breakdown</button>
                </div>
            </div>
        </form>

        {% if section1 %}
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Cost</div>
                    <div class="stat-value">${{ section1.total_costs|floatformat:2 }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Period</div>
                    <div class="stat-value">{{ section1.selected_month_label }}</div>
                </div>
            </div>

            {% if section1.transaction_breakdown %}
                <h3>Transaction Type Breakdown</h3>
                <table class="breakdown-table">
                    <thead>
                        <tr>
                            <th>Transaction Type</th>
                            <th class="text-right">Record Count</th>
                            <th class="text-right">Total Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in section1.transaction_breakdown %}
                            <tr>
                                <td>{{ item.transaction_type }}</td>
                                <td class="text-right">{{ item.record_count|floatformat:0 }}</td>
                                <td class="text-right">${{ item.total_amount|floatformat:2 }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}
        {% endif %}
    </div>

    <!-- SECTION 2: Range A vs Range B Comparison -->
    <div class="dashboard-section">
        <h2 class="section-title">‚öñÔ∏è Period Comparison</h2>

        <form method="get" action="" id="comparisonForm">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="range_a_months">Range A (hold Ctrl/Cmd to select multiple):</label>
                    <select id="range_a_months" name="range_a_months[]" multiple>
                        {% for month_option in month_options %}
                            <option value="{{ month_option.value }}" {% if month_option.value in range_a_months %}selected{% endif %}>
                                {{ month_option.label }}
                            </option>
                        {% endfor %}
                    </select>
                    <p class="help-text">e.g., July 2024, Aug 2024</p>
                </div>

                <div class="filter-group">
                    <label for="range_b_months">Range B (hold Ctrl/Cmd to select multiple):</label>
                    <select id="range_b_months" name="range_b_months[]" multiple>
                        {% for month_option in month_options %}
                            <option value="{{ month_option.value }}" {% if month_option.value in range_b_months %}selected{% endif %}>
                                {{ month_option.label }}
                            </option>
                        {% endfor %}
                    </select>
                    <p class="help-text">e.g., July 2025, Aug 2025</p>
                </div>

                <div class="filter-group">
                    <label for="location">Filter by Location:</label>
                    <select id="location" name="location">
                        <option value="">-- All Locations --</option>
                        {% for loc in locations %}
                            <option value="{{ loc.location_id }}" {% if loc.location_id == selected_location %}selected{% endif %}>
                                {{ loc.location_id }} - {{ loc.location_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="department">Filter by Department:</label>
                    <select id="department" name="department">
                        <option value="">-- All Departments --</option>
                        {% for dept in departments %}
                            <option value="{{ dept.department_id }}" {% if dept.department_id == selected_department %}selected{% endif %}>
                                {{ dept.department_id }} - {{ dept.department_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button type="submit">Compare</button>
                </div>
            </div>
        </form>

        {% if section2 %}
            <div class="summary-totals">
                <div class="stat-grid">
                    <div>
                        <div class="stat-label">Range A Total ({{ section2.range_a_labels|join:", " }})</div>
                        <div class="stat-value">${{ section2.range_a_total|floatformat:2 }}</div>
                    </div>
                    <div>
                        <div class="stat-label">Range B Total ({{ section2.range_b_labels|join:", " }})</div>
                        <div class="stat-value">${{ section2.range_b_total|floatformat:2 }}</div>
                    </div>
                    <div>
                        <div class="stat-label">Variance</div>
                        <div class="stat-value {% if section2.total_variance >= 0 %}positive{% else %}negative{% endif %}">
                            ${{ section2.total_variance|floatformat:2 }}
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button type="button" class="download-btn" onclick="downloadComparison()">
                    üì• Download Detailed Report
                </button>
            </div>

            <h3>Employee Comparison (Top Variances)</h3>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Employee Code</th>
                        <th>Employee Name</th>
                        <th class="text-right">Range A Cost</th>
                        <th class="text-right">Range B Cost</th>
                        <th class="text-right">Variance</th>
                    </tr>
                </thead>
                <tbody>
                    {% for emp in section2.comparison_list|slice:":50" %}
                        <tr>
                            <td>{{ emp.employee_code }}</td>
                            <td>{{ emp.full_name }}</td>
                            <td class="text-right">${{ emp.range_a_cost|floatformat:2 }}</td>
                            <td class="text-right">${{ emp.range_b_cost|floatformat:2 }}</td>
                            <td class="text-right {% if emp.variance >= 0 %}positive{% else %}negative{% endif %}">
                                ${{ emp.variance|floatformat:2 }}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <p class="help-text" style="margin-top: 10px;">Showing top 50 employees by variance. Download full report for all employees.</p>
        {% endif %}
    </div>

    <!-- SECTION 3: Bridge/Waterfall Chart -->
    {% if section3 %}
    <div class="dashboard-section">
        <h2 class="section-title">üåâ Cost Movement Analysis</h2>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Continuing Employees</div>
                <div class="stat-value">{{ section3.continuing_count }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">New Employees</div>
                <div class="stat-value positive">+{{ section3.new_count }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Departed Employees</div>
                <div class="stat-value negative">-{{ section3.departed_count }}</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="waterfallChart"></canvas>
        </div>

        <div class="waterfall-legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #3498db;"></div>
                <span>Opening Balance (Range A)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #27ae60;"></div>
                <span>Positive Changes</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #e74c3c;"></div>
                <span>Negative Changes</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #9b59b6;"></div>
                <span>Closing Balance (Range B)</span>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
    // Waterfall chart initialization
    {% if section3 %}
    const ctx = document.getElementById('waterfallChart');

    const labels = ['Opening Balance'];
    const data = [{{ section3.opening_balance }}];
    const colors = ['#3498db'];

    // Add location deltas
    {% for location, delta in section3.location_deltas.items %}
        labels.push('{{ location }}');
        data.push({{ delta }});
        colors.push({{ delta }} >= 0 ? '#27ae60' : '#e74c3c');
    {% endfor %}

    // Add new headcount
    if ({{ section3.new_headcount }} !== 0) {
        labels.push('New Employees');
        data.push({{ section3.new_headcount }});
        colors.push('#27ae60');
    }

    // Add departed headcount
    if ({{ section3.departed_headcount }} !== 0) {
        labels.push('Departed Employees');
        data.push({{ section3.departed_headcount }});
        colors.push('#e74c3c');
    }

    // Add closing balance
    labels.push('Closing Balance');
    data.push({{ section3.closing_balance }});
    colors.push('#9b59b6');

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Cost Movement',
                data: data,
                backgroundColor: colors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Cost Movement from Range A to Range B',
                    font: {
                        size: 16
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let value = context.parsed.y || 0;
                            return '$' + value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                        }
                    }
                },
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    formatter: function(value) {
                        return '$' + value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                    },
                    font: {
                        weight: 'bold',
                        size: 11
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                        }
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
    {% endif %}

    // Download comparison function
    function downloadComparison() {
        const form = document.getElementById('comparisonForm');
        const formData = new FormData(form);

        // Build query string
        const params = new URLSearchParams();
        for (const [key, value] of formData.entries()) {
            params.append(key, value);
        }

        // Trigger download
        window.location.href = '{% url "reconciliation:download_comparison_data" %}?' + params.toString();
    }
</script>
{% endblock %}
